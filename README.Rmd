---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
library(knitr)
library(kableExtra)
library(DT)
knitr::opts_chunk$set(
  collapse    = TRUE,
  comment     = "#>",
  fig.path    = "man/figures/README-",
  out.width   = "40%",
  eval        = TRUE
)
```

# cdssr <img src="man/figures/cdssr_logo.png" align="right" width="25%" />

<!-- badges: start -->
[![Dependencies](https://img.shields.io/badge/dependencies-9/02-orange?style=flat)](#)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://choosealicense.com/licenses/mit/)
<!-- badges: end -->

<div align="left">

  <p align="left">
    <a href="https://dwr.state.co.us/Tools"><strong>« CDSS »</strong></a>
    <br />
    <a href="https://dwr.state.co.us/Rest/GET/Help">CDSS API</a>
  </p>
</div>

<hr>

The goal of `cdssr` is to provide functions that help R users to navigate, explore, and make requests to the [CDSS REST API web service](https://dwr.state.co.us/Rest/GET/Help). 

The Colorado's Decision Support Systems (CDSS) is a water management system created and developed by the [Colorado Water Conservation Board (CWCB)](https://cwcb.colorado.gov/) and the [Colorado Division of Water Resources (DWR)](https://dwr.colorado.gov/). 

Thank you to those at CWCB and DWR for providing an accessible and well documented REST API! 

<hr>

## Installation

You can install the development version of `cdssr` from [GitHub](https://github.com/) with:

```{r, eval=FALSE, echo=TRUE}
# install.packages("devtools")
devtools::install_github("anguswg-ucsb/cdssr")
```

## Browse avaliable endpoints

To browse all the available endpoints shown [here](https://dwr.state.co.us/Rest/GET/Help) use `browse_api()`.

```{r, eval=TRUE, echo=TRUE}
# Load package
library(cdssr)
```

```{r browse_api_ex, eval=TRUE, echo=TRUE}
# View the catalog of avaliable endpoints
catalog <- cdssr::browse_api()

# catalog
dplyr::tibble(catalog)
```

<br>

## View the return fields
Use `preview_endpoint()` Inspect what fields will be returned for a given endpoint by entering a `endpoint_url` (a column in the `browse_api()` output pointing to the endpoints help page)
```{r return_fields_ex, eval=TRUE, echo=TRUE}
# Return expected data fields for a given endpoint
return_fields <- cdssr::preview_endpoint(endpoint_url = catalog$endpoint_url[3])

dplyr::tibble(return_fields)
```

<br>

# Example: Telemetry site data

## Identify station locations and information 
We can use the `_stations()` functions to identify what stations are within a given AOI, water district, division, or county.
```{r get_tele_stations, eval=TRUE, echo=TRUE}
# identify telemetry stations in water district 6
stations <- cdssr::get_telemetry_stations(
  water_district = 6
  )

dplyr::tibble(stations)
```

<br>

```{r plot_tele_stations, eval=TRUE, echo=TRUE, fig.align='center', out.width='100%'}
plot(stations$latitude~stations$longitude)
```

<br>

## Retrieve Reference Tables to help generate queries
The `get_reference_tbl()` function will return tables that makes it easier to know what information should be supplied to the data retrieval functions in `cdssr`. For more information on the exact reference tables click [here](https://dwr.state.co.us/rest/get/help#Datasets&#ReferenceTablesController&#gettingstarted&#jsonxml).

Let's locate the parameters available at telemetry stations.
```{r get_tele_params, eval=TRUE, echo=TRUE}
# available parameters for telemetry stations
telemetry_params <- cdssr::get_reference_tbl(
  table_name = "telemetryparams"
  )

dplyr::tibble(telemetry_params)
```

<br>

## Retrieve Telemetry station timeseries data 
Use `get_` function to make requests to the CDSS API and return the results in a tidy dataframe.

We'll use the station abbreviations from the `get_telemetry_stations()` call, a parameter from the `get_reference_tbl()` call, select a starting and ending date and a temporal resolution. 
```{r get_ts, eval=TRUE, echo=TRUE}
# Daily discharge at "ANDDITCO" telemetry station
discharge_ts <- cdssr::get_telemetry_ts(
                      abbrev              = stations$abbrev[1],
                      parameter           = telemetry_params$parameter[7],
                      start_date          = "2015-01-01",
                      end_date            = "2022-01-01",
                      timescale           = "day"
                               )

dplyr::tibble(discharge_ts)
```

And a plot of the daily discharge...
```{r plot_ts, eval=TRUE, echo=TRUE, fig.align='center', out.width='100%'}
# Plot daily discharge at "ANDDITCO"
plot(discharge_ts$value~discharge_ts$datetime, type = "l")
```


<br>

# Example: Spatial search

## Find structures/stations from coordinates
A spatial search for structures/stations can be made by supplying an SF point/polygon to the `aoi` argument and a numeric value for the desired `radius` to search within./

```{r spatial_search, eval=TRUE, echo=TRUE}
library(sf)

# create a spatial point
pt <- sf::st_as_sf(
            data.frame(
              lng = -105.549  , 
              lat = 40.672
            ),
            coords = c("lng", "lat"),
            crs = 4326
            )

# locate structures within 10 miles of point
structures <- cdssr::get_structures(
  aoi    = pt,
  radius = 10
  )

dplyr::tibble(structures)
```

<br>

```{r plot_spatial_search, eval=TRUE, echo=TRUE, fig.align='center', out.width='100%'}
plot(structures$latdecdeg~structures$longdecdeg)
```
<br>

## Retrieve Diversion records for multiple structures
We can then use the WDID's found from the spatial search to retrieve diversion/release/stage/volume data from multiple structures using `get_structures_divrec`.

```{r get_divrec, eval=TRUE, echo=TRUE}
# create a character vector of WDID's for all active ditch structures
ditch_wdids <- 
  structures %>% 
    dplyr::filter(ciu_code == "A", structure_type == "DITCH") %>% 
  .$wdid

# get diversion records
diversion_rec <- 
  cdssr::get_structures_divrec(
                        wdid           = ditch_wdids,
                        wc_identifier  = "diversion",
                        type           = "month"
                        )

dplyr::tibble(diversion_rec)
```

<br>

```{r plot_divrec, eval=TRUE, echo=TRUE, fig.align='center', out.width='100%'}
library(ggplot2)

diversion_rec %>% 
  ggplot2::ggplot() +
  ggplot2::geom_col(ggplot2::aes(x = datetime, y = data_value, fill = wdid)) +
  ggplot2::facet_wrap(~wdid, nrow = 3)

```


<br>

# Example: Groundwater well data

## Retrieve groundwater well data
The `get_groundwater()` function lets users make get requests to the various CDSS API groundwater endpoints using the **type** parameter.

Groundwater endpoints:

  - [api/v2/groundwater/waterlevels/wellmeasurements](https://dwr.state.co.us/Rest/GET/Help/Api/GET-api-v2-groundwater-waterlevels-wellmeasurements)
  - [api/v2/groundwater/waterlevels/wells](https://dwr.state.co.us/Rest/GET/Help/Api/GET-api-v2-groundwater-waterlevels-wells)
  - [api/v2/groundwater/geophysicallogs/wells](https://dwr.state.co.us/Rest/GET/Help/Api/GET-api-v2-groundwater-geophysicallogs-wells)

```{r get_gw, eval=TRUE, echo=TRUE}
# Use type = "wellmeasurements" to request wellmeasurements endpoint (api/v2/groundwater/waterlevels/wellmeasurements)
well_measure <- cdssr::get_groundwater(
  type    = "wellmeasurements",
  wellid  = 1274
  )

dplyr::tibble(well_measure)
```

And a plot of the depth to water over time...
```{r plot_gw, eval=TRUE, echo=TRUE, fig.align='center', out.width='100%'}
# plot depth to water
plot(well_measure$depth_to_water~well_measure$datetime, type = "l")
```

<br>
<br>

> **More functions for more endpoints coming soon!**










